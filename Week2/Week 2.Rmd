---
title: "Week 2 Lab"
date: "`r Sys.Date()`"
author: "Tutor: Sanghyun Kim"
output: 
  html_document: 
    ### IMPORTANT ###
    # self_contained: true # Creates a single HTML file as output
    code_folding: show # Code folding; allows you to show/hide code chunks
    ### USEFUL ###
    code_download: true # Includes a menu to download the code file
    ### OPTIONAL ###
    df_print: paged # Sets how dataframes are automatically printed
    theme: readable # Controls the font, colours, etc.
    toc: true # (Useful) Creates a table of contents!
    toc_float: true # table of contents at the side
    number_sections: false # (Optional) Puts numbers next to heading/subheadings
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
```

# Group Exercise

## Australian Road Fatalities

```{r}
fdata = readxl::read_excel("bitre_fatalities_jun2024.xlsx", sheet = 2, skip = 4, na = c("","-9"), guess_max = 1e6)
glimpse(fdata)
```

## Cereal

```{r}
path = "https://github.com/DATA2002/data/raw/master/Cereal.csv"
cereal = readr::read_csv(path, na = "-1")
glimpse(cereal)
```

# Exercises

## Tablet Devices

```{r}
y_i = c(102, 32, 12, 4)
p_i = c(0.69, 0.21, 0.07, 0.03) # null hypothesised distribution
n = sum(y_i)
e_i = n * p_i
```

```{r}
y_i = c(102, 32, 12 + 4)
p_i = c(0.69, 0.21, 0.07 + 0.03)
n = sum(y_i)
e_i = n * p_i
t0 = sum((y_i - e_i)^2/e_i)
t0
```

```{r}
pval = pchisq(t0, df = 2, lower.tail = FALSE)
pval
```

```{r}
chisq.test(y_i, p = p_i)
```

1. Hypothesis

$$H_0:\ p_1=0.69,\ p_2=0.21,\ p_3=0.1 \ \ \ \text{vs} \ \ \ H_1:\text{At least one of the equalities doesn't hold}$$

2. Assumption

- Observations are randomly selected & independent of each other

- $e_i=np_i\ge5 \ \ \text{for all} \ i$

3. Test Statistic

$$T=\sum_{i=1}^{3}{\frac{(Y_i-e_i)^2}{e_i}}\sim\chi_2^2 \ \ \text{Under} \ H_0$$

4. Observed Test Statistic

$$t_0=\sum_{i=1}^{3}{\frac{(y_i-e_i)^2}{e_i}}\sim\chi_2^2 \ \ \text{Under} \ H_0 = 0.096$$

5. P-value

$P(T\ge t_0) = P(\chi_2^2\ge0.0963)=0.953$

6. Decision

Since the p-value is greater than $\alpha=0.05$, we don't reject $H_0$, meaning that the data is consistent with the distribution of tablet devices in 2012.

## Smoking Rates

```{r}
y_i = c(44, 24, 13, 19)
p_i = c(0.5, 0.2, 0.1, 0.2)
n = sum(y_i)
e_i = n * p_i
t0 = sum((y_i - e_i)^2/e_i)
t0
```

```{r}
pval = pchisq(t0, df = 3, lower.tail = FALSE)
pval
```

```{r}
chisq.test(y_i, p = p_i)
```

1. Hypothesis

$$H_0:\ p_1=0.5,\ p_2=0.2,\ p_3=0.1, \ p_4=0.2 \ \ \ \text{vs} \ \ \ H_1:\text{At least one of the equalities doesn't hold}$$

2. Assumption

- Observations are randomly selected & independent of each other

- $e_i=np_i\ge5 \ \ \text{for all} \ i$

3. Test Statistic

$$T=\sum_{i=1}^{4}{\frac{(Y_i-e_i)^2}{e_i}}\sim\chi_3^2 \ \ \text{Under} \ H_0$$

4. Observed Test Statistic

$$t_0=\sum_{i=1}^{4}{\frac{(y_i-e_i)^2}{e_i}}\sim\chi_3^2 \ \ \text{Under} \ H_0 = 2.47$$

5. P-value

$P(T\ge t_0) = P(\chi_3^2\ge2.47)=0.481$

6. Decision

Since the p-value is greater than $\alpha=0.05$, we don't reject $H_0$, meaning that the data is consistent with the proportions estimated by the researcher.

# Australian Road Fatalities

## How are missing values recorded and why might they occur?

```{r}
# fatalities data
fdata = readxl::read_excel("bitre_fatalities_jun2024.xlsx", 
                           sheet = 2, 
                           skip = 4, 
                           na = c("","-9"), 
                           guess_max = 1e6) %>%  
  janitor::clean_names()

# crash data
cdata = fdata %>%  
  select(-road_user, -gender, -age, -age_group) %>%  
  distinct() %>% 
  group_by(crash_id) %>%  
  slice(1) %>%  
  ungroup() %>% 
  mutate(hour = lubridate::hour(time))
```

## How many fatalities occurred since 1989? How many fatal crashes have there been since 1989?

```{r}
nrow(fdata)
```

```{r}
cdata = fdata %>% 
    select(-road_user, -gender, -age, -age_group) %>% 
    distinct()

nrow(cdata)

cdata %>% 
    select(crash_id) %>% 
    n_distinct()
```

```{r}
cdata %>% 
    group_by(crash_id) %>% 
    filter(n() > 1)
```

```{r}
cdata = cdata %>% 
    group_by(crash_id) %>% 
    slice(1) %>% 
    ungroup()

nrow(cdata)
```

## What is the most common hour of the day for a fatal crash?

```{r}
cdata = cdata %>% 
    mutate(hour = lubridate::hour(time))
```

```{r}
cdata %>% 
  ggplot() + 
  aes(x = hour) + 
  geom_bar()
```

## What is the most common day of the week for a fatal crash?

```{r}
cdata %>% 
  ggplot() +
  aes(x = dayweek) +
  geom_bar()
```

```{r}
cdata = cdata %>% 
  mutate(dayweek = factor(dayweek, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))

cdata %>% 
  ggplot() + 
  aes(x = dayweek) + 
  geom_bar() +
  labs(x = "", y = "Number of fatalities")
```

```{r}
cdata = cdata %>% 
    mutate(dayweek = factor(dayweek, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")))

cdata %>% 
  ggplot() + 
  aes(x = dayweek) + 
  geom_bar() + 
  labs(x = "", y = "Number of fatalities")
```

## What is the most common month for a fatal crash?

```{r}
cdata %>% 
  ggplot() + 
  aes(x = month) + 
  geom_bar()
```

```{r}
cdata = cdata %>% 
  mutate(month_named = factor(month, levels = 1:12, labels = month.abb))

cdata %>% 
  ggplot() +
  aes(x = month_named) + 
  geom_bar() + 
  labs(x = "", y = "Number of fatalities")
```

## Are fatal crashes uniformly distributed across the months of the year?

```{r}
mcount = cdata %>% 
  filter(year == 2019) %>% 
  dplyr::count(month_named)

mcount
```

1. Hypothesis

$$H_0:\ p_1=p_2=p_3=\ ...\ =p_{12}=\frac{1}{12} \ \ \ \text{vs} \ \ \ H_1:\text{At least one of the equalities doesn't hold}$$

2. Assumption

- Observations are randomly selected & independent of each other

- $e_i=np_i\ge5 \ \ \text{for all} \ i$

```{r}
mcount = mcount %>% 
  mutate(expected = (1/12) * sum(n))

mcount$expected >= 5
```

3. Test Statistic

$$T=\sum_{i=1}^{12}{\frac{(Y_i-e_i)^2}{e_i}}\sim\chi_{11}^2 \ \ \text{Under} \ H_0$$

4. Observed Test Statistic

$$t_0=\sum_{i=1}^{12}{\frac{(y_i-e_i)^2}{e_i}}\sim\chi_{11}^2 \ \ \text{Under} \ H_0=8.51$$

```{r}
Tstat = sum(((mcount$n - mcount$expected)^2)/mcount$expected)
Tstat
```

5. P-value

$P(T\ge t_0) = P(\chi_{11}^2\ge8.51) = 0.667$

```{r}
1 - pchisq(Tstat, df = 11)
pchisq(Tstat, df = 11, lower.tail = FALSE)
chisq.test(mcount$n)
```

6. Decision

Since the p-value is greater than $\alpha=0.05$, we don't reject $H_0$, meaning that the data is consistent with the proposed uniform distribution.

